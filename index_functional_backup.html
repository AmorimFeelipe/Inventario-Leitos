<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>Invent√°rio de Leitos - Capacidade Instalada - SES-AM</title>

    <link rel="manifest" href="manifest.json" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />


    <style>
      :root {
        --bg-body: #f8fafc;
        --bg-sidebar: #0f172a;
        --bg-card: #ffffff;
        --text-primary: #004d99;
        --text-secondary: #64748b;
        --accent-primary: #4c9a2a;
        --accent-dark: #37731f;
        --danger: #ef4444; 
        
        --tag-uti: #fef2f2;
        --tag-text-uti: #b91c1c;
        --tag-clinico: #e0f2fe;
        --tag-text-clinico: #0369a1;

        --border-color: #e2e8f0;
        --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        --header-height: 70px;
        --sidebar-width: 260px;
      }

      * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }

      body {
        font-family: "Inter", sans-serif;
        background-color: var(--bg-body);
        color: var(--text-primary);
        height: 100dvh; /* Altura real do mobile */
        overflow: hidden;
        display: flex;
      }

      /* --- SIDEBAR --- */
      .sidebar {
        width: var(--sidebar-width);
        background-color: var(--bg-sidebar);
        color: #f8fafc;
        display: flex;
        flex-direction: column;
        padding: 20px;
        padding-top: max(20px, env(safe-area-inset-top)); 
        flex-shrink: 0;
        transition: transform 0.3s ease;
        z-index: 1000;
        height: 100%;
      }

      .sidebar-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 30px;
      }

      .brand {
        font-size: 18px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 12px;
        color: white;
      }

      .brand-icon {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--accent-primary);
        flex-shrink: 0;
      }

      .close-sidebar-btn {
          background: none;
          border: none;
          color: white;
          font-size: 32px;
          cursor: pointer;
          display: none; 
          padding: 0 10px;
          line-height: 1;
      }

      .nav-menu {
        display: flex;
        flex-direction: column;
        gap: 6px;
        flex: 1;
        overflow-y: auto;
      }

      .nav-item {
        padding: 12px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        color: #94a3b8;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .nav-item:hover { background-color: rgba(255, 255, 255, 0.1); color: white; }
      .nav-item.active { background-color: var(--accent-primary); color: white; box-shadow: 0 4px 12px rgba(76, 154, 42, 0.4); }

      .add-btn {
        background-color: var(--accent-primary);
        color: white;
        padding: 12px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        border: none;
        cursor: pointer;
        margin-top: 20px;
        width: 100%;
        box-shadow: 0 4px 12px rgba(76, 154, 42, 0.3);
        margin-bottom: env(safe-area-inset-bottom);
      }
      .add-btn:hover { background-color: var(--accent-dark); }

      /* --- MAIN CONTENT --- */
      .main-wrapper {
        flex: 1;
        display: flex;
        flex-direction: column;
        height: 100%;
        overflow: hidden;
        position: relative;
        width: 100%;
      }
      
      /* Overlay Escuro */
      .overlay-backdrop {
          position: fixed; top:0; left:0; width:100%; height:100%;
          background: rgba(0,0,0,0.5); z-index: 900;
          display: none;
          backdrop-filter: blur(2px);
      }
      .overlay-backdrop.active { display: block; }

      .top-header {
        min-height: var(--header-height);
        padding-top: env(safe-area-inset-top); 
        background: var(--bg-card);
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding-left: 16px;
        padding-right: 16px;
        padding-bottom: 8px;
        flex-shrink: 0;
        z-index: 50;
      }

      .header-left { display: flex; align-items: center; gap: 12px; flex: 1; overflow: hidden; }
      
      .menu-toggle {
        display: none;
        background: none;
        border: none;
        font-size: 28px;
        cursor: pointer;
        color: var(--text-primary);
        padding: 4px;
        margin-right: 4px;
      }

      .header-logo { height: 38px; width: auto; object-fit: contain; }
      
      .page-title {
          font-size: 18px;
          font-weight: 700;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
      }

      .header-right { display: flex; align-items: center; gap: 10px; }

      .btn-export {
          display: flex;
          align-items: center;
          gap: 6px;
          background: #f1f5f9;
          border: 1px solid var(--border-color);
          padding: 8px 12px;
          border-radius: 8px;
          font-size: 13px;
          font-weight: 600;
          color: var(--text-primary);
          cursor: pointer;
      }

      .content-area {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        scroll-behavior: smooth;
        padding-bottom: 80px; 
      }



      /* --- TOOLBAR & CARDS --- */
      .toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-bottom: 20px;
      }
      .search-wrapper { flex: 1; min-width: 200px; position: relative; }
      .search-input {
        width: 100%;
        padding: 12px 12px 12px 40px;
        border-radius: 10px;
        border: 1px solid var(--border-color);
        font-size: 14px;
      }
      .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #94a3b8; }

      .grid-view {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
      }

      .unit-card {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 20px;
        display: flex;
        flex-direction: column;
        transition: transform 0.2s;
      }
      
      .card-header-row {
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
          margin-bottom: 16px;
      }
      
      .unit-info h3 { font-size: 16px; font-weight: 700; margin-bottom: 4px; color: var(--text-primary); }
      .unit-cat { font-size: 11px; background: #f1f5f9; padding: 4px 8px; border-radius: 6px; color: var(--text-secondary); text-transform: uppercase; font-weight: 600; }
      
      .card-actions { display: flex; gap: 8px; }
      .btn-icon-card {
          width: 32px; height: 32px;
          border-radius: 8px;
          border: 1px solid var(--border-color);
          background: white;
          cursor: pointer;
          display: flex; align-items: center; justify-content: center;
          font-size: 16px;
      }

      .total-badge {
          background: linear-gradient(135deg, var(--accent-primary), var(--accent-dark));
          color: white;
          padding: 6px 10px;
          border-radius: 8px;
          text-align: center;
          font-weight: 700;
          font-size: 14px;
      }
      .total-badge span { display: block; font-size: 9px; opacity: 0.9; font-weight: 500; text-transform: uppercase; }

      .types-list { display: flex; flex-wrap: wrap; gap: 6px; margin: 12px 0 20px 0; }
      .type-tag {
          font-size: 12px; padding: 4px 8px; border-radius: 6px; border: 1px solid transparent;
          display: flex; gap: 6px; align-items: center;
      }
      .type-tag b { font-weight: 700; }
      .tag-uti { background: var(--tag-uti); color: var(--tag-text-uti); border-color: #fee2e2; }
      .tag-cli { background: var(--tag-clinico); color: var(--tag-text-clinico); border-color: #e0f2fe; }

      /* --- ESTRUTURA HIER√ÅRQUICA DE LEITOS --- */
      .bed-type-group {
        border: 1px solid var(--border-color);
        border-radius: 10px;
        padding: 12px;
        margin-bottom: 12px;
        background: #f8fafc;
      }
      .bed-type-header {
        font-weight: 700;
        font-size: 14px;
        color: var(--text-primary);
        margin-bottom: 8px;
        padding: 8px;
        background: white;
        border-radius: 6px;
        border-left: 4px solid var(--accent-primary);
      }
      .sub-bed-container {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-left: 12px;
      }
      .sub-bed-row {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .sub-bed-row input[type="text"] {
        flex: 2;
      }
      .sub-bed-row input[type="number"] {
        flex: 1;
      }
      .add-sub-bed-btn {
        margin-top: 6px;
        padding: 6px 12px;
        font-size: 12px;
        background: white;
        border: 1px dashed var(--accent-primary);
        color: var(--accent-primary);
        border-radius: 6px;
        cursor: pointer;
        width: 100%;
        font-weight: 500;
      }
      .add-sub-bed-btn:hover {
        background: #f0fdf4;
      }


      /* --- MODAL --- */
      .modal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.6); z-index: 2000;
        display: none; justify-content: center; align-items: center;
        padding: 20px;
        backdrop-filter: blur(4px);
      }
      .modal.active { display: flex; }
      .modal-content {
        background: white; padding: 24px; border-radius: 16px;
        width: 100%; max-width: 550px; max-height: 90vh; overflow-y: auto;
        box-shadow: 0 20px 50px rgba(0,0,0,0.2);
        animation: fadeIn 0.3s ease;
      }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

      .form-group { margin-bottom: 16px; }
      .form-input, .form-select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); font-size: 14px; }
      .bed-input-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
      .remove-bed-btn {
          width: 40px; height: 42px; background: #fee2e2; color: #dc2626; border: none; border-radius: 8px; cursor: pointer;
          font-size: 20px; display: flex; align-items: center; justify-content: center;
      }
      .btn-save { background: var(--accent-primary); color: white; border: none; padding: 14px; border-radius: 8px; width: 100%; font-weight: 600; cursor: pointer; font-size: 16px; }
      
      /* --- TABLE VIEW --- */
      .table-container { display: none; overflow-x: auto; background: white; border-radius: 12px; border: 1px solid var(--border-color); }
      .data-table { width: 100%; border-collapse: collapse; min-width: 600px; }
      .data-table th, .data-table td { padding: 16px; text-align: left; border-bottom: 1px solid var(--border-color); }
      .data-table th { background: #f8fafc; font-size: 12px; text-transform: uppercase; color: var(--text-secondary); font-weight: 600; }

      /* --- MOBILE CORRE√á√ïES (Menu Lateral) --- */
      @media (max-width: 768px) {
        .sidebar {
          position: fixed; 
          left: 0; 
          top: 0; 
          bottom: 0;
          width: 85%; 
          max-width: 320px;
          box-shadow: 4px 0 20px rgba(0,0,0,0.2);
          
          transform: translateX(-100%); /* Escondido */
          transition: transform 0.3s ease;
          z-index: 1100; 
        }
        
        /* Estado Aberto */
        .sidebar.active {
          transform: translateX(0); /* Vis√≠vel */
        }
        
        .close-sidebar-btn { display: block; }
        .menu-toggle { display: block; }
        
        .page-title { font-size: 16px; margin-left: 0; display: block; }
        .header-logo { height: 32px; display: block; }

        /* Ajustes layout */
        .charts-row { grid-template-columns: 1fr; height: auto; }
        .chart-container { height: 300px; }
        .toolbar { flex-direction: column; align-items: stretch; }
        .search-wrapper { width: 100%; }
        
        #user-id-display { display: none; }
      }
    </style>
  </head>

  <body>
    <div class="overlay-backdrop" id="overlay-backdrop"></div>

    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
          <div class="brand">
            <div class="brand-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
            </div>
            <span>Gest√£o Leitos</span>
          </div>
          <button class="close-sidebar-btn" id="close-sidebar">&times;</button>
      </div>

      <nav class="nav-menu">
        <div class="nav-item active" data-filter="all">üè¢ Rede Completa</div>
        <div class="nav-item" data-filter="Maternidade">üë∂ Maternidades</div>
        <div class="nav-item" data-filter="HPS">üöë HPS</div>
        <div class="nav-item" data-filter="HPSC">üè• HPSC</div>
        <div class="nav-item" data-filter="Infantil">üß∏ Infantil</div>
        <div class="nav-item" data-filter="UPA">ü©∫ UPAs</div>
        <div class="nav-item" data-filter="Funda√ß√£o">üî¨ Funda√ß√µes</div>
        <div class="nav-item" data-filter="SPA">ü©π SPAs</div>
      </nav>

      <button class="add-btn" id="add-unit-btn">+ Adicionar Unidade</button>
    </aside>

    <div class="main-wrapper" id="main-wrapper">
      <header class="top-header">
        <div class="header-left">
          <button class="menu-toggle" id="menu-toggle">‚ò∞</button>
          
          <img src="image_28787b.png" 
               onerror="this.style.display='none'; document.getElementById('text-fallback').style.display='block';" 
               class="header-logo" alt="Logo" />
          
          <span id="text-fallback" style="display:none; font-weight:800; font-size:16px; margin-right:10px; color:var(--accent-primary);">SES-AM</span>

          <span class="page-title">Total de Leitos</span>
        </div>
        
        <div class="header-right">
            <button class="btn-export" id="btn-export">üì• <span style="display:none; @media(min-width:600px){display:inline}">Exportar</span></button>
            <div style="font-size:11px; text-align:right; color: #64748b;" id="user-id-display">...</div>
        </div>
      </header>

      <div class="content-area">


        <div class="toolbar">
          <div class="search-wrapper">
            <span class="search-icon">üîç</span>
            <input type="text" class="search-input" id="search-input" placeholder="Buscar unidade ou leito..." />
          </div>
        </div>


        <div id="loading-state" style="text-align:center; padding:40px;">Carregando dados...</div>
        <div id="grid-view" class="grid-view"></div>

        <div id="empty-state" style="display:none; text-align:center; padding:40px; color:#94a3b8;">Nenhuma unidade encontrada.</div>
      </div>
    </div>

    <div id="add-unit-modal" class="modal">
      <div class="modal-content">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px; align-items:center;">
            <h2 id="modal-title" style="font-size:20px;">Adicionar Unidade</h2>
            <button id="modal-close-btn" style="background:none; border:none; font-size:28px; cursor:pointer;">&times;</button>
        </div>
        <form id="add-unit-form">
          <input type="hidden" id="unit-id-hidden"> 
          
          <div class="form-group">
            <label>Selecione uma Unidade</label>
            <select id="unit-template" class="form-select">
              <option value="">-- Ou preencha manualmente abaixo --</option>
              <optgroup label="SPAs">
                <option value="spa-alvorada">SPA ALVORADA</option>
                <option value="spa-coroado">SPA COROADO</option>
                <option value="spa-zona-sul">SPA ZONA SUL</option>
                <option value="spa-eliameme">SPA ELIAMEME RODRIGUES MADY</option>
                <option value="spa-joventina">SPA JOVENTINA DIAS</option>
                <option value="spa-chapot">SPA CHAPOT PREVOST</option>
                <option value="spa-jose-lins">SPA JOSE LINS</option>
                <option value="spa-danilo">SPA DANILO CORREA</option>
                <option value="spa-sao-raimundo">SPA S√ÉO RAIMUNDO</option>
              </optgroup>
              <optgroup label="Funda√ß√µes">
                <option value="fundacao-hemoam">FUNDA√á√ÉO HEMOAM</option>
                <option value="fuham">FUHAM</option>
                <option value="fundacao-adriano-jorge">FUNDA√á√ÉO HOSPITAL ADRIANO JORGE</option>
                <option value="fundacao-medicina-tropical">FUNDA√á√ÉO DE MEDICINA TROPICAL</option>
              </optgroup>
            </select>

          </div>
          
          <div class="form-group">
            <label>Nome da Unidade</label>
            <input type="text" id="unit-name" class="form-input" placeholder="Ex: HPS 28 de Agosto" required />
            <small id="name-feedback"></small>
          </div>

          <div class="form-group">
            <label>Categoria</label>
            <select id="unit-category" class="form-select" required>
              <option value="HPS">HPS</option><option value="HPSC">HPSC</option><option value="Maternidade">Maternidade</option>
              <option value="Infantil">Infantil</option><option value="UPA">UPA</option><option value="Funda√ß√£o">Funda√ß√£o</option>
              <option value="SPA">SPA</option><option value="Outro">Outro</option>
            </select>
          </div>
          <div class="form-group">
            <label>Invent√°rio <span style="font-size:12px; color:#64748b; font-weight:400;">(Clique no X vermelho para excluir um tipo)</span></label>
            <div id="bed-inventory-inputs"></div>
            <button type="button" id="add-bed-input" style="margin-top:10px; padding:10px; width:100%; border:1px dashed #ccc; background:#f8fafc; border-radius:8px; cursor:pointer; font-weight:500;">+ Adicionar Tipo de Leito</button>
          </div>
          <button type="submit" class="btn-save">Salvar Altera√ß√µes</button>
        </form>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import { getFirestore, collection, onSnapshot, setDoc, deleteDoc, getDoc, doc, serverTimestamp, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // CONFIGURA√á√ÉO FIREBASE
      const firebaseConfig = {
        apiKey: "AIzaSyCQ_MSZ1sIli8PRda5bQVYMKwgmHJLtKwA",
        authDomain: "gestao-leitos.firebaseapp.com",
        projectId: "gestao-leitos",
        storageBucket: "gestao-leitos.firebasestorage.app",
        messagingSenderId: "594249273990",
        appId: "1:594249273990:web:6c601f868ad9b0a4157707"
      };

      const appId = "gestao-leitos-web";
      let db, auth, userId;
      let units = [];
      let chartInstances = {};

      // Templates de unidades pr√©-cadastradas
      const templatesUnidades = {
        // SPAs - modo livre (sem tipos pr√©-definidos)
        "spa-alvorada": { nome: "SPA ALVORADA", categoria: "SPA" },
        "spa-coroado": { nome: "SPA COROADO", categoria: "SPA" },
        "spa-zona-sul": { nome: "SPA ZONA SUL", categoria: "SPA" },
        "spa-eliameme": { nome: "SPA ELIAMEME RODRIGUES MADY", categoria: "SPA" },
        "spa-joventina": { nome: "SPA JOVENTINA DIAS", categoria: "SPA" },
        "spa-chapot": { nome: "SPA CHAPOT PREVOST", categoria: "SPA" },
        "spa-jose-lins": { nome: "SPA JOSE LINS", categoria: "SPA" },
        "spa-danilo": { nome: "SPA DANILO CORREA", categoria: "SPA" },
        "spa-sao-raimundo": { nome: "SPA S√ÉO RAIMUNDO", categoria: "SPA" },
        
        // Funda√ß√µes - com tipos CNES pr√©-definidos
        "fundacao-hemoam": {
          nome: "FUNDA√á√ÉO HEMOAM",
          categoria: "Funda√ß√£o",
          tiposLeitos: ["ESPEC - CLINICO", "PEDIATRICO", "HOSPITAL DIA", "COMPLEMENTAR", "ESPEC - CIRURGICO"]
        },
        "fuham": {
          nome: "FUHAM",
          categoria: "Funda√ß√£o",
          tiposLeitos: ["HOSPITAL DIA"]
        },
        "fundacao-adriano-jorge": {
          nome: "FUNDA√á√ÉO HOSPITAL ADRIANO JORGE",
          categoria: "Funda√ß√£o",
          tiposLeitos: ["HOSPITAL DIA", "ESPEC - CIRURGICO", "OUTRAS ESPECIALIDADES", "COMPLEMENTAR", "ESPEC - CLINICO"]
        },
        "fundacao-medicina-tropical": {
          nome: "FUNDA√á√ÉO DE MEDICINA TROPICAL",
          categoria: "Funda√ß√£o",
          tiposLeitos: ["COMPLEMENTAR", "PEDIATRICO", "ESPEC - CLINICO", "OUTRAS ESPECIALIDADES", "HOSPITAL DIA"]
        }
      };


      // DOM Elements

      const sidebar = document.getElementById("sidebar");
      const overlay = document.getElementById("overlay-backdrop");
      const modal = document.getElementById("add-unit-modal");
      const form = document.getElementById("add-unit-form");
      const bedInputs = document.getElementById("bed-inventory-inputs");
      const unitNameInput = document.getElementById("unit-name");
      const nameFeedback = document.createElement("small");
      nameFeedback.style.display = "block"; nameFeedback.style.marginTop = "4px"; nameFeedback.style.fontWeight = "600";
      unitNameInput.parentNode.appendChild(nameFeedback);
      
      // INIT
      async function init() {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        
        try { await enableIndexedDbPersistence(db); } catch(e) {}

        onAuthStateChanged(auth, async (user) => {
          if(!user) await signInAnonymously(auth);
          userId = auth.currentUser.uid;
          document.getElementById('user-id-display').textContent = 'ID: ' + userId.substring(0,8);
          loadData();
        });
      }

      function loadData() {
        const col = collection(db, `artifacts/${appId}/public/data/hospital_inventory`);
        onSnapshot(col, (snap) => {
          units = [];
          snap.forEach(d => units.push({id: d.id, ...d.data()}));
          render();
          document.getElementById('loading-state').style.display = 'none';
        });
      }

      // RENDER
      let filter = 'all';
      let search = '';

      function render() {
        const filtered = units.filter(u => {
           const matchFilter = filter === 'all' || u.category === filter;
           const matchSearch = u.name.toLowerCase().includes(search.toLowerCase()) || 
                               u.inventory.some(i => i.type.toLowerCase().includes(search.toLowerCase()));
           return matchFilter && matchSearch;
        }).sort((a,b) => b.totalBeds - a.totalBeds);

        if (filtered.length === 0) {
            document.getElementById('empty-state').style.display = 'block';
            document.getElementById('grid-view').style.display = 'none';
        } else {
            document.getElementById('empty-state').style.display = 'none';
            document.getElementById('grid-view').style.display = 'grid';
        }




        // Grid
        const grid = document.getElementById('grid-view');
        grid.innerHTML = '';
        filtered.forEach(unit => {
            const card = document.createElement('div');
            card.className = 'unit-card';
            const total = unit.inventory.reduce((a,b) => a + (+b.quantity||0), 0);
            const totalNaoCad = unit.inventory.reduce((a,b) => a + (+b.naoCadastrados||0), 0);
            
            card.innerHTML = `
                <div class="card-header-row">
                    <div class="unit-info">
                        <h3>${unit.name}</h3>
                        <span class="unit-cat">${unit.category}</span>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <div class="total-badge">${total}<span>Leitos</span></div>
                        ${totalNaoCad > 0 ? `<div class="total-badge" style="background: #fee2e2; color: #dc2626;">${totalNaoCad}<span style="color: #dc2626;">N√£o cad.</span></div>` : ''}
                    </div>
                </div>

                <div class="types-list">
                    ${unit.inventory.map(i => {
                        let detalhamento = `<b>${i.quantity}</b>`;
                        if (i.cadastrados !== undefined && i.naoCadastrados !== undefined) {
                            detalhamento = `<b>${i.quantity}</b> <span style="font-size:10px; color:#64748b;">(${i.cadastrados} cad. / ${i.naoCadastrados} n\u00e3o cad.)</span>`;
                        }
                        return `<span class="type-tag ${i.type.toLowerCase().includes('uti')?'tag-uti':'tag-cli'}">${i.type}: ${detalhamento}</span>`;
                    }).join('')}
                </div>

                <div style="margin-top:auto; padding-top:15px; border-top:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center;">
                   <span style="font-size:10px; color:#94a3b8;">Ref: ${unit.id.substring(0,8)}</span>
                   <div class="card-actions">
                      <button class="btn-icon-card btn-edit" title="Editar / Excluir Leitos">‚úèÔ∏è</button>
                      <button class="btn-icon-card btn-del" title="Excluir Unidade">üóëÔ∏è</button>
                   </div>
                </div>
            `;
            
            card.querySelector('.btn-edit').onclick = () => openEditModal(unit);
            card.querySelector('.btn-del').onclick = () => confirmDelete(unit.id, unit.name);
            grid.appendChild(card);
        });

      }




      // --- EDIT & DELETE LOGIC ---
      window.confirmDelete = async (id, name) => {
          if(confirm(`Tem certeza que deseja EXCLUIR a unidade "${name}"?\nIsso n√£o pode ser desfeito.`)) {
              try {
                  await deleteDoc(doc(db, `artifacts/${appId}/public/data/hospital_inventory`, id));
              } catch(e) { alert('Erro ao excluir: ' + e.message); }
          }
      }

      window.openEditModal = (unit) => {
          document.getElementById('modal-title').textContent = "Editar / Excluir Leitos";
          document.getElementById('unit-id-hidden').value = unit.id; 
          document.getElementById('unit-name').value = unit.name;
          document.getElementById('unit-category').value = unit.category;
          
          bedInputs.innerHTML = '';
          
          // Detectar se tem estrutura hier√°rquica (cadastrados/naoCadastrados)
          const temHierarquia = unit.inventory.some(i => i.cadastrados !== undefined || i.naoCadastrados !== undefined);
          
          if (temHierarquia) {
              // Agrupar por tipo principal (antes do " - ")
              const grupos = {};
              unit.inventory.forEach(item => {
                  const partes = item.type.split(' - ');
                  if (partes.length > 1) {
                      const tipoPrincipal = partes[0];
                      const subTipo = partes.slice(1).join(' - ');
                      if (!grupos[tipoPrincipal]) grupos[tipoPrincipal] = [];
                      grupos[tipoPrincipal].push({
                          nome: subTipo,
                          cadastrados: item.cadastrados || 0,
                          naoCadastrados: item.naoCadastrados || 0
                      });
                  } else {
                      // Item sem tipo principal, adicionar como grupo √∫nico
                      if (!grupos[item.type]) grupos[item.type] = [];
                      grupos[item.type].push({
                          nome: '',
                          cadastrados: item.cadastrados || 0,
                          naoCadastrados: item.naoCadastrados || 0
                      });
                  }
              });
              
              // Recriar grupos de tipos com sub-leitos
              Object.keys(grupos).forEach(tipoPrincipal => {
                  const groupDiv = document.createElement('div');
                  groupDiv.className = 'bed-type-group';
                  groupDiv.dataset.tipo = tipoPrincipal;
                  
                  groupDiv.innerHTML = `
                    <div class="bed-type-header">${tipoPrincipal}</div>
                    <div style="display:flex; gap:8px; align-items:center; padding:0 0 4px 0; margin-left:12px; font-size:10px; font-weight:600; color:#64748b; text-transform:uppercase; letter-spacing:0.5px;">
                      <span style="flex:3; padding-left:12px;">Nome do Sub-Leito</span>
                      <span style="flex:1; text-align:center;">Cadastrados</span>
                      <span style="flex:1; text-align:center;">N√£o Cadastr.</span>
                      <span style="width:40px;"></span>
                    </div>
                    <div class="sub-bed-container"></div>
                    <button type="button" class="add-sub-bed-btn">+ Adicionar sub-leito</button>
                  `;




                  
                  const subContainer = groupDiv.querySelector('.sub-bed-container');
                  const addSubBtn = groupDiv.querySelector('.add-sub-bed-btn');
                  
                  // Fun√ß√£o para adicionar sub-leito
                  const addSubBed = (nome = '', cad = 0, naoCad = 0) => {
                      const subRow = document.createElement('div');
                      subRow.className = 'sub-bed-row';
                      subRow.innerHTML = `
                        <input type="text" class="form-input" placeholder="Nome do sub-leito" value="${nome}" required style="flex: 3;">
                        <input type="number" class="form-input" placeholder="Cadastrados" value="${cad}" required min="0" style="flex: 1;">
                        <input type="number" class="form-input" placeholder="N√£o cadastrados" value="${naoCad}" required min="0" style="flex: 1;">
                        <button type="button" class="remove-bed-btn" title="Remover">&times;</button>
                      `;
                      subRow.querySelector('.remove-bed-btn').onclick = () => subRow.remove();
                      subContainer.appendChild(subRow);
                  };
                  
                  addSubBtn.onclick = () => addSubBed();
                  
                  // Adicionar sub-leitos existentes
                  grupos[tipoPrincipal].forEach(sub => {
                      addSubBed(sub.nome, sub.cadastrados, sub.naoCadastrados);
                  });
                  
                  bedInputs.appendChild(groupDiv);
              });
          } else {
              // Estrutura plana (antiga)
              unit.inventory.forEach((item, idx) => addBedRow(item.type, item.quantity));
              if(unit.inventory.length === 0) addBedRow(); 
          }
          
          nameFeedback.textContent = '';
          modal.classList.add('active');
      }


      // --- FORM & SAVING ---
      function addBedRow(type='', qtd='') {
          const div = document.createElement('div');
          div.className = 'bed-input-row';
          div.innerHTML = `
             <input type="text" class="form-input bed-type" placeholder="Tipo (Ex: UTI)" value="${type}" required>
             <input type="number" class="form-input bed-qtd" placeholder="Qtd" value="${qtd}" required>
             <button type="button" class="remove-bed-btn" title="Excluir este leito">&times;</button>
          `;
          div.querySelector('.remove-bed-btn').onclick = () => div.remove();
          bedInputs.appendChild(div);
      }

      form.addEventListener('submit', async (e) => {
          e.preventDefault();
          const btn = form.querySelector('.btn-save');
          const oldText = btn.textContent;
          btn.textContent = "Salvando..."; btn.disabled = true;

          const name = document.getElementById('unit-name').value.trim();
          const cat = document.getElementById('unit-category').value;
          
          let id = document.getElementById('unit-id-hidden').value;
          if(!id) id = name.toLowerCase().replace(/[^a-z0-9]+/g, '-');

          const newInv = [];
          
          // Verificar se h√° estrutura hier√°rquica (grupos de tipos)
          const typeGroups = document.querySelectorAll('.bed-type-group');
          if (typeGroups.length > 0) {
              // Estrutura hier√°rquica: processar sub-leitos por tipo
              typeGroups.forEach(group => {
                  const tipoPrincipal = group.dataset.tipo;
                  const subRows = group.querySelectorAll('.sub-bed-row');
                  subRows.forEach(subRow => {
                      const inputs = subRow.querySelectorAll('.form-input');
                      const subTipo = inputs[0].value.trim();
                      const cadastrados = parseInt(inputs[1].value) || 0;
                      const naoCadastrados = parseInt(inputs[2].value) || 0;
                      const total = cadastrados + naoCadastrados;
                      
                      if (subTipo && total > 0) {
                          newInv.push({
                              type: `${tipoPrincipal} - ${subTipo}`,
                              quantity: total,
                              cadastrados: cadastrados,
                              naoCadastrados: naoCadastrados
                          });
                      }
                  });
              });
          } else {
              // Estrutura plana: modo livre (SPAs ou manual)
              document.querySelectorAll('.bed-input-row').forEach(row => {
                  const t = row.querySelector('.bed-type').value.trim();
                  const q = parseInt(row.querySelector('.bed-qtd').value);
                  if (t && q > 0) newInv.push({type: t, quantity: q});
              });
          }



          const total = newInv.reduce((a,b) => a + b.quantity, 0);

          try {
              await setDoc(doc(db, `artifacts/${appId}/public/data/hospital_inventory`, id), {
                  name: name, category: cat, inventory: newInv, totalBeds: total,
                  lastUpdated: serverTimestamp(), userId: userId
              });
              modal.classList.remove('active');
          } catch(err) {
              alert("Erro ao salvar: " + err.message);
          } finally {
              btn.textContent = oldText; btn.disabled = false;
          }
      });

      // AUTO-PREENCHIMENTO
      unitNameInput.addEventListener('input', () => {
          if(document.getElementById('unit-id-hidden').value) return; 

          const typed = unitNameInput.value.trim();
          const sid = typed.toLowerCase().replace(/[^a-z0-9]+/g, '-');
          if(!sid) { nameFeedback.textContent = ''; return; }
          
          const found = units.find(u => u.id === sid);
          if(found) {
              nameFeedback.textContent = "‚úÖ Unidade existente! Dados carregados.";
              nameFeedback.style.color = "#4C9A2A";
              document.getElementById('unit-category').value = found.category;
              bedInputs.innerHTML = '';
              found.inventory.forEach(i => addBedRow(i.type, i.quantity));
          } else {
              nameFeedback.textContent = "‚ú® Nova Unidade";
              nameFeedback.style.color = "#64748b";
          }
      });

      // EXPORT
      document.getElementById('btn-export').onclick = () => {
          let csv = "Unidade;Categoria;Tipo de Leito;Quantidade\n";
          units.forEach(u => {
              if(u.inventory.length === 0) {
                  csv += `${u.name};${u.category};Sem leitos;0\n`;
              } else {
                  u.inventory.forEach(i => {
                      csv += `${u.name};${u.category};${i.type};${i.quantity}\n`;
                  });
              }
          });
          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url; a.download = 'relatorio_leitos.csv';
          a.click();
      };

      // UI EVENTS
      
      // Abre o Menu
      document.getElementById('menu-toggle').onclick = () => {
          sidebar.classList.add('active');
          overlay.classList.add('active');
      };

      // Fecha o Menu (Bot√£o X ou clicando fora)
      function closeSidebar() {
          sidebar.classList.remove('active');
          overlay.classList.remove('active');
      }
      document.getElementById('close-sidebar').onclick = closeSidebar;
      overlay.onclick = closeSidebar;

      document.getElementById('modal-close-btn').onclick = () => modal.classList.remove('active');
      document.getElementById('add-bed-input').onclick = () => addBedRow();
      
      // Auto-preenchimento ao selecionar template de unidade
      document.getElementById('unit-template').onchange = (e) => {
          const templateId = e.target.value;
          const unitNameInput = document.getElementById('unit-name');
          const unitCategorySelect = document.getElementById('unit-category');
          
          if (templateId && templatesUnidades[templateId]) {
              const template = templatesUnidades[templateId];
              unitNameInput.value = template.nome;
              unitCategorySelect.value = template.categoria;
              unitNameInput.readOnly = true;
              unitCategorySelect.disabled = true;
              unitNameInput.style.backgroundColor = '#f1f5f9';
              unitCategorySelect.style.backgroundColor = '#f1f5f9';
              
              // Se template tem tipos pr√©-definidos, criar estrutura hier√°rquica
              if (template.tiposLeitos && template.tiposLeitos.length > 0) {
                  bedInputs.innerHTML = '';
                  template.tiposLeitos.forEach(tipo => {
                      createBedTypeGroup(tipo);
                  });
              } else {
                  // Modo livre (SPAs)
                  bedInputs.innerHTML = '';
                  addBedRow();
              }
          } else {
              unitNameInput.readOnly = false;
              unitCategorySelect.disabled = false;
              unitNameInput.style.backgroundColor = '';
              unitCategorySelect.style.backgroundColor = '';
              bedInputs.innerHTML = '';
              addBedRow();
          }
      };
      
      // Fun√ß√£o para criar grupo de tipo com sub-leitos
      function createBedTypeGroup(tipoPrincipal) {
          const groupDiv = document.createElement('div');
          groupDiv.className = 'bed-type-group';
          groupDiv.dataset.tipo = tipoPrincipal;
          
          groupDiv.innerHTML = `
            <div class="bed-type-header">${tipoPrincipal}</div>
            <div style="display:flex; gap:8px; align-items:center; padding:0 0 4px 0; margin-left:12px; font-size:10px; font-weight:600; color:#64748b; text-transform:uppercase; letter-spacing:0.5px;">
              <span style="flex:3; padding-left:12px;">Nome do Sub-Leito</span>
              <span style="flex:1; text-align:center;">Cadastrados</span>
              <span style="flex:1; text-align:center;">N√£o Cadastr.</span>
              <span style="width:40px;"></span>
            </div>
            <div class="sub-bed-container"></div>
            <button type="button" class="add-sub-bed-btn">+ Adicionar sub-leito</button>
          `;




          
          const subContainer = groupDiv.querySelector('.sub-bed-container');
          const addSubBtn = groupDiv.querySelector('.add-sub-bed-btn');
          
          // Fun√ß√£o para adicionar sub-leito
          const addSubBed = () => {
              const subRow = document.createElement('div');
              subRow.className = 'sub-bed-row';
              subRow.innerHTML = `
                <input type="text" class="form-input" placeholder="Nome do sub-leito" required style="flex: 3;">
                <input type="number" class="form-input" placeholder="Cadastrados" value="0" required min="0" style="flex: 1;">
                <input type="number" class="form-input" placeholder="N√£o cadastrados" value="0" required min="0" style="flex: 1;">
                <button type="button" class="remove-bed-btn" title="Remover">&times;</button>
              `;
              subRow.querySelector('.remove-bed-btn').onclick = () => subRow.remove();
              subContainer.appendChild(subRow);
          };

          
          addSubBtn.onclick = addSubBed;
          
          // Adicionar um sub-leito inicial
          addSubBed();
          
          bedInputs.appendChild(groupDiv);
      }

      


      document.getElementById('add-unit-btn').onclick = () => {
          document.getElementById('unit-id-hidden').value = ''; 
          document.getElementById('modal-title').textContent = "Adicionar Unidade";
          form.reset(); bedInputs.innerHTML = ''; addBedRow();
          nameFeedback.textContent = '';
          
          // Resetar dropdown de templates e desbloquear campos
          document.getElementById('unit-template').value = '';
          document.getElementById('unit-name').readOnly = false;
          document.getElementById('unit-category').disabled = false;
          document.getElementById('unit-name').style.backgroundColor = '';
          document.getElementById('unit-category').style.backgroundColor = '';
          
          closeSidebar();
          modal.classList.add('active');
      };


      document.getElementById('search-input').oninput = (e) => { search = e.target.value; render(); };
      
      document.querySelectorAll('.nav-item').forEach(el => {
          el.onclick = () => {
              document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
              el.classList.add('active');
              filter = el.dataset.filter;
              closeSidebar();
              render();
          };
      });

      init();

    </script>
  </body>
</html>